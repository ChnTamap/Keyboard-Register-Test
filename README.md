# 键盘方案

- USB，蓝牙，2.4G三模
- 74HC165寄存器扫描方案
- WS2812 RGB
- 预留双边扩展
- 基于CH58x验证

# WS2812B驱动

RGB灯通讯

- [x] IO延时验证硬件通过
- [x] SPI方案(DMA)
  - [ ] ~~与按键扫描共用一个SPI~~(目前没想到方案)
- [x] TMR方案(PWM+DMA)
- [x] UART方案(FIFO)

## 时序

| 时序表称                  | Min. | Type | Max. | 单位 |
| ------------------------- | ---- | ---- | ---- | ---- |
| T 码元周期                | 1.20 | --   | --   | μs   |
| T0H 0 码， 高电平时间     | 0.2  | 0.3  | 0.4  | μs   |
| T0L 0 码， 低电平时间     | 0.8  | --   | --   | μs   |
| T1H 1 码， 高电平时间     | 0.58 | 0.64 | 1.0  | μs   |
| T1L 1 码， 低电平时间     | 0.2  | --   | --   | μs   |
| Trst Reset 码，低电平时间 | >80  | --   | --   | μs   |

_来自数据手册1_

| 时序表称                  | Min. | Max. | 单位 |
| ------------------------- | ---- | ---- | ---- |
| T0H 0 码， 高电平时间     | 0.22 | 0.38 | μs   |
| T0L 0 码， 低电平时间     | 0.58 | 1.0  | μs   |
| T1H 1 码， 高电平时间     | 0.58 | 1.0  | μs   |
| T1L 1 码， 低电平时间     | 0.58 | 1.0  | μs   |
| Trst Reset 码，低电平时间 | >280 | --   | μs   |

_来自数据手册2_

先高电平在低电平, 低电平须小于80us(否则会认为复位)

如: 周期1.2us时, 0码可取25%, 1码可取50%
如: 周期 1/(60MHz / 1 / 64) = 1.067us时, 0: 28%=18, 1: 60%=38

## IO验证方案

[src\demo\ws2812b_io.c](src\demo\ws2812b_io.c)

## 定时器PWM方案（DMA）

使用TMR的PWM输出，利用DMA自动读取占空比。

RAM空间占用：
| 1bit   | 1LED    | 128LED |
| ------ | ------- | ------ |
| 4 Byte | 96 Byte | 12 KB  |

[src\demo\ws2812b_tmr.c](src\demo\ws2812b_tmr.c)

## SPI方案（DMA）

使用SPI的MOSI口，结合DMA。

RAM空间占用：
| 1bit     | 1LED    | 128LED |
| -------- | ------- | ------ |
| 1 Byte   | 24 Byte | 3 KB   |
| 1/2 Byte | 12 Byte | 1.5 KB |

[src\demo\ws2812b_spi.c](src\demo\ws2812b_spi.c)

## 串口方案（FIFO）

先发低电平再发高电平，低电平是上个位的，高电平是当前位的。由于串口固定了下降沿（停止位+起始位）必须等周期，因此一个字节必须发超过一个位才能有机会规避这个问题

RAM空间占用：
| 1bit     | 1LED    | 128LED |
| -------- | ------- | ------ |
| 1/2 Byte | 12 Byte | 1.5 KB |
| 1/3 Byte | 8 Byte  | 1 KB   |

[src\demo\ws2812b_uart.c](src\demo\ws2812b_uart.c)
[src\demo\ws2812b_uart_it.c](src\demo\ws2812b_uart_it.c)

主频可选波特率:
- 80MHz : 10MHz : 200ns 300ns 400ns
- 60MHz : 7.5MHz : 200ns 266ns 400ns
- 48MHz : 6MHz : 333ns
- 36.9MHz : 4.6125MHz : 216.8ns

### 6+2

300ns:
N61 300ns 2:1       34.7kLED/s  中断周期19.2us

| 位  | 高电平 | 低电平 | 数据 |
| --- | ------ | ------ | ---- |
| 0   | 1      | 2~3    | 1000 |
| 1   | 2~3    | 2~3    | 1100 |

| 3b  | LHLH | 300        |
| --- | ---- | ---------- |
| 000 | 0000 | 0 001000 1 |
| 001 | 0001 | 0 001001 1 |
| 010 | 0110 | 0 011000 1 |
| 011 | 0111 | 0 011001 1 |
| 100 | 1000 | 0 001000 1 |
| 101 | 1001 | 0 001001 1 |
| 110 | 1110 | 0 011000 1 |
| 111 | 1111 | 0 011001 1 |

### 8+2

300ns:
N81 300ns (!)3:1    41.7kLED/s  中断周期24us
333ns:
N81 333ns (!)3:1    37.5kLED/s  中断周期26.64us
400ns:
N81 400ns (!)3:1    31.3kLED/s  中断周期32us

| 位  | 高电平 | 低电平 | 数据     |
| --- | ------ | ------ | -------- |
| 0   | 1      | 2~     | 100 1000 |
| 1   | 2      | 1~     | 110 1100 |

| 3b  | <400         | HEX |
| --- | ------------ | --- |
| 000 | 0 01001000 1 | 12  |
| 001 | 0 01001001 1 | 92  |
| 010 | 0 01001100 1 | 32  |
| 011 | 0 01001101 1 | B2  |
| 100 | 0 01101000 1 | 16  |
| 101 | 0 01101001 1 | 96  |
| 110 | 0 01101100 1 | 36  |
| 111 | 0 01101101 1 | B6  |

### 8+1+2

300ns:
E81 300ns (!)3:1    37.9kLED/s  中断周期 26.4us
333ns:
E81 333ns (!)3:1    34.1kLED/s  中断周期29.3us
400ns:
E81 400ns (!)3:1    28.4kLED/s  中断周期35.2us

| 3b  | 400           | HEX |
| --- | ------------- | --- |
| 000 | 0 01000100 01 | 22  |
| 001 | 0 01001001 11 | 92  |
| 010 | 0 01001110 01 | 72  |
| 011 | 0 01000110 11 | 62  |
| 100 | 0 01110010 01 | 4E  |
| 101 | 0 01100100 11 | 26  |
| 110 | 0 01100110 01 | 66  |
| 111 | 0 01110110 11 | 6E  |

### 总结

| Fsys    | Baud        | Bits | LED/Byte | LED/s  | IntPeriod | 128LED  |
| ------- | ----------- | ---- | -------- | ------ | --------- | ------- |
| -       | 1.2us/bit   | -    | -        | 34.7 K | -         | 3.69 ms |
| 80M     | 3333333.333 | 8    | 2        | 34.7 K | 19.2 us   | 3.69 ms |
| 80M     | 3333333.333 | 10   | 3        | 41.7 K | 24.0 us   | 3.07 ms |
| 48M     | 3000000     | 10   | 3        | 37.5 K | 26.7 us   | 3.41 ms |
| 60M 80M | 2500000     | 10   | 3        | 31.3 K | 32.0 us   | 4.10 ms |
| 80M     | 3333333.333 | 11   | 3        | 37.9 K | 26.4 us   | 3.38 ms |
| 48M     | 3000000     | 11   | 3        | 34.1 K | 29.3 us   | 3.75 ms |
| 60M 80M | 2500000     | 11   | 3        | 28.4 K | 35.2 us   | 4.51 ms |

## 驱动框架

ws2812b驱动过程为: 软件计算好要发送的数据并保存到缓冲区, 交给相应的外设发送出去
但不同的板子LED数量不同, 且相同LED数量下, 不同的外设所需的数据量也是不同的(如TMR4字节发送1位, 而串口1字节可发送3位)
并且同一串数据必须一次性发完(或者暂停时间很短), 因为低电平时间存在上限

更广泛的, 该架构可能不止适用于ws2812b, 包括单色,三色LED矩阵或其他可寻址RGB也可以接入
该驱动的需求同LCD等驱动有些相像, 因此可以参考LCD驱动:

1. LCD的框架结构分为: 应用层-GUI库-GUI库接口程序-外设驱动
   1. 应用层: 用户程序, 使用UI控件
   2. GUI库: 对控件进行渲染, 根据颜色格式生成显示数据
   3. 接口程序: 接收来自GUI库的显示数据, 调用外设驱动, 提供显存空间
   4. 外设驱动: 驱动硬件外设如SPI, FSMC等
2. 相应的
   1. 应用: 接受按键输入, 控制发光模式等
   2. 渲染: 根据LED布局, 提供渐变,动画...等效果, 根据生成显示数据
   3. 接口: 调用外设发送显示数据, 提供缓存
   4. 驱动: 驱动硬件外设如SPI, PWM, UART, IO...
3. 其中应用与GUI库属于 应用层或框架, 而接口和外设则属于驱动层
   1. 应用: (软件)应用程序
   2. 渲染: (库)框架/库/应用程序
   3. 接口: (板级)驱动程序
   4. 驱动: (芯片)外设驱动程序

### 函数

`init(dev)`
初始化设备

`write(dev, data, len)`
发送RGB数据

`(*tx_cb)(dev)`
发送完成回调

...

# 74HC165驱动

按键扫描功能

| PIN | 功能             | 描述       |
| --- | ---------------- | ---------- |
| PL  | 异步并行加载输入 | 低电平加载 |
| CE  | 时钟使能输入     | 低电平使能 |
| CP  | 移位时钟输入     | 上升沿触发 |
| Q7  | 串行输出         |            |

注: 在CP低电平时, 如果CE发生上升沿, 数据也会移位(这两个PIN效果基本是一样的)

## SPI方案

| MCU  | PIN | 说明                             |
| ---- | --- | -------------------------------- |
| PL   | PL  | 通讯前低电平, 通讯时保持高电平   |
| CS   | CE  | 片选, 低电平使能时钟输入         |
| SCLK | CP  | 时钟输入                         |
| MISO | Q7  | 数据, 时钟上升沿输出, 下降沿采集 |

理想模式:
- SCLK高电平空闲
- 第一个时钟沿(下降沿)采样
- 8位数据, 高位在前

假设需要1ms扫描128个按键, 则至少需要128KHz的时钟频率

### CH58x SPI0

该芯片只能修改空闲电平, 高低位顺序, 但其总是在 SCK 上升沿采样串行数据输入，在下降沿输出串行数据。

当SCK上升沿时, 芯片会进行采样, 随后芯片接收到SCK上升信号到输出数据有一点延时
因此顺序可能为: SCL上升-MCU采样-芯片输出MISO

与芯片模式相适应的SPI模式为:
- SCK低电平空闲
- 采样不可选(第一个时钟沿)
- MSB

## WS2812与按键扫描共用SPI

注: 由于CH58x目前不知道如何实现SPI全双工, 因此此方法暂时无效

### SPI定时法

假设有128个LED, 每个位约1.2us, 共 128\*24\*1.2us=3.6864ms, LED刷新周期暂定约30ms.
即每30ms进行一次约3.7ms刷新

假设有128个按键, 暂定每1ms需要扫描一次按键, 则则SPI时钟周期需要小于(1ms/128=7.8125us)

目前每个SPI字节可以发送两个LED位, 则SPI时钟周期约为: (1.2us\*2/8=300ns), 满足按键的需求

LED每个位间的低电平根据不同产商不同可能会有不同的标准, 暂时认为应当小于1us(保守时间, 实际可以更长. 必须小于30us, 这个时间是部分产商RGB的复位时间)

因此, 可以通过设定特定的DMA数量将DMA中断确定在按键需要扫描的时间附近, 然后与按键扫描一起开始SPI, 结束后继续剩余的数据

#### 计算

1. 每毫秒字节数: 1ms/SPI时钟周期/8 = SPI时钟频率\*8\*1ms = 1ms/300ns/8 = 416.67
2. LED字节数: LED数\*24*每个LED位的SPI字节数 = 128\*24\*0.5 = 1536 个SPI字节
3. 按键字节数: 按键数/8 = 128/8 = 16 个SPI字节
4. 每毫秒除按键外剩余字节数: 毫秒字节数-按键字节数 = 400.67

因此:
1. RGB与按键同时使用时:先收发16个字节, 再发401个字节, 比1ms多了0.333个字节(800ns)的时间,
2. 经过3次发送, 将发送出(16+401)\*3=1251个SPI字节, 耗时约3.0024ms, 剩余285个SPI字节
3. 第四次, 先收发16个字节, 再发送(285-16)=269字节. 完成一次LED刷新
4. 后续按键扫描每毫秒收发16个即可, 直到下一次LED刷新开始
