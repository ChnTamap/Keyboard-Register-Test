# WS2812B驱动

RGB灯通讯

## IO验证方案

## 定时器PWM方案（DMA）

## SPI方案（DMA）

## 串口方案（FIFO）

先发低电平再发高电平，低电平是上个位的，高电平是当前位的。由于串口固定了下降沿（停止位+起始位）必须等周期，因此一个字节必须发超过一个位才能有机会规避这个问题

主频:
- 80MHz : 10MHz : 200ns 300ns 400ns
- 60MHz : 7.5MHz : 200ns 266ns 400ns
- 48MHz : 6MHz : 333ns
- 36.9MHz : 4.6125MHz : 216.8ns

### 6+2

300ns:
N61 300ns 2:1       34.7kLED/s  中断周期19.2us

| 位  | 高电平 | 低电平 | 数据 |
| --- | ------ | ------ | ---- |
| 0   | 1      | 2~3    | 1000 |
| 1   | 2~3    | 2~3    | 1100 |

| 3b  | LHLH | 300        |
| --- | ---- | ---------- |
| 000 | 0000 | 0 001000 1 |
| 001 | 0001 | 0 001001 1 |
| 010 | 0110 | 0 011000 1 |
| 011 | 0111 | 0 011001 1 |
| 100 | 1000 | 0 001000 1 |
| 101 | 1001 | 0 001001 1 |
| 110 | 1110 | 0 011000 1 |
| 111 | 1111 | 0 011001 1 |

### 8+2

300ns:
N81 300ns (!)3:1    41.7kLED/s  中断周期24us
333ns:
N81 333ns (!)3:1    37.5kLED/s  中断周期26.64us
400ns:
N81 400ns (!)3:1    31.3kLED/s  中断周期32us

| 位  | 高电平 | 低电平 | 数据     |
| --- | ------ | ------ | -------- |
| 0   | 1      | 2~     | 100 1000 |
| 1   | 2      | 1~     | 110 1100 |

| 3b  | <400         | HEX |
| --- | ------------ | --- |
| 000 | 0 01001000 1 | 12  |
| 001 | 0 01001001 1 | 92  |
| 010 | 0 01001100 1 | 32  |
| 011 | 0 01001101 1 | B2  |
| 100 | 0 01101000 1 | 16  |
| 101 | 0 01101001 1 | 96  |
| 110 | 0 01101100 1 | 36  |
| 111 | 0 01101101 1 | B6  |

### 8+1+2

300ns:
E81 300ns (!)3:1    37.9kLED/s  中断周期 26.4us
333ns:
E81 333ns (!)3:1    34.1kLED/s  中断周期29.3us
400ns:
E81 400ns (!)3:1    28.4kLED/s  中断周期35.2us

| 3b  | 400           | HEX |
| --- | ------------- | --- |
| 000 | 0 01000100 01 | 22  |
| 001 | 0 01001001 11 | 92  |
| 010 | 0 01001110 01 | 72  |
| 011 | 0 01000110 11 | 62  |
| 100 | 0 01110010 01 | 4E  |
| 101 | 0 01100100 11 | 26  |
| 110 | 0 01100110 01 | 66  |
| 111 | 0 01110110 11 | 6E  |

### 总结

| Fsys    | Baud        | Bits | LED/Byte | LED/s  | IntPeriod | 128LED  |
| ------- | ----------- | ---- | -------- | ------ | --------- | ------- |
| -       | 1.2us/bit   | -    | -        | 34.7 K | -         | 3.69 ms |
| 80M     | 3333333.333 | 8    | 2        | 34.7 K | 19.2 us   | 3.69 ms |
| 80M     | 3333333.333 | 10   | 3        | 41.7 K | 24.0 us   | 3.07 ms |
| 48M     | 3000000     | 10   | 3        | 37.5 K | 26.7 us   | 3.41 ms |
| 60M 80M | 2500000     | 10   | 3        | 31.3 K | 32.0 us   | 4.10 ms |
| 80M     | 3333333.333 | 11   | 3        | 37.9 K | 26.4 us   | 3.38 ms |
| 48M     | 3000000     | 11   | 3        | 34.1 K | 29.3 us   | 3.75 ms |
| 60M 80M | 2500000     | 11   | 3        | 28.4 K | 35.2 us   | 4.51 ms |

# 74HC165驱动

按键扫描功能

| PIN | 功能             | 描述       |
| --- | ---------------- | ---------- |
| PL  | 异步并行加载输入 | 低电平加载 |
| CE  | 时钟使能输入     | 低电平使能 |
| CP  | 移位时钟输入     | 上升沿触发 |
| Q7  | 串行输出         |            |

注: 在CP低电平时, 如果CE发生上升沿, 数据也会移位(这两个PIN效果基本是一样的)

## SPI方案

| MCU  | PIN | 说明                             |
| ---- | --- | -------------------------------- |
| PL   | PL  | 通讯前低电平, 通讯时保持高电平   |
| CS   | CE  | 片选, 低电平使能时钟输入         |
| SCLK | CP  | 时钟输入                         |
| MISO | Q7  | 数据, 时钟上升沿输出, 下降沿采集 |

理想模式:
- SCLK高电平空闲
- 第一个时钟沿(下降沿)采样
- 8位数据, 高位在前

假设需要1ms扫描128个按键, 则至少需要128KHz的时钟频率

### CH58x SPI0

该芯片只能修改空闲电平, 高低位顺序, 但其总是在 SCK 上升沿采样串行数据输入，在下降沿输出串行数据。

当SCK上升沿时, 芯片会进行采样, 随后芯片接收到SCK上升信号到输出数据有一点延时
因此顺序可能为: SCL上升-MCU采样-芯片输出MISO

与芯片模式相适应的SPI模式为:
- SCK低电平空闲
- 采样不可选(第一个时钟沿)
- MSB

